<?php

namespace App\Http\Controllers;

use App\Models\PengaturanDenda;
use App\Models\PeminjamanBuku;
use App\Models\Denda;
use App\Models\User;
use Illuminate\Http\Request;
use Carbon\Carbon;
use Illuminate\Support\Facades\Notification;
use App\Notifications\ReminderDenda;
use Illuminate\Support\Facades\Mail;
use App\Mail\ReminderEmail;
use App\Mail\PeminjamanBaruEmail;
use App\Mail\PengingatPengembalianEmail;
use App\Mail\PeringatanKeterlambatanEmail;
use Illuminate\Support\Facades\Log;

class ReminderController extends Controller
{
    // Tambahkan method ini di ReminderController
    private function getStatusPeminjaman($peminjaman)
    {
        $pengaturan = PengaturanDenda::getAktif();
        if (!$pengaturan) {
            return [
                'status' => 'tidak_ada_pengaturan',
                'hari' => 0,
                'denda' => 0
            ];
        }

        $tanggalKembali = Carbon::parse($peminjaman->tanggal_kembali);
        $today = Carbon::today();

        if ($tanggalKembali->gte($today)) {
            // Masih dalam waktu
            $hariTersisa = $today->diffInDays($tanggalKembali);
            return [
                'status' => 'dalam_waktu',
                'hari' => $hariTersisa,
                'denda' => 0
            ];
        }

        // Sudah lewat tanggal kembali
        $hariTerlambat = $today->diffInDays($tanggalKembali);
        $masaTenggangEnd = $tanggalKembali->copy()->addDays($pengaturan->masa_tenggang);

        if ($today->lte($masaTenggangEnd)) {
            // Dalam masa tenggang
            return [
                'status' => 'masa_tenggang',
                'hari' => $hariTerlambat,
                'denda' => 0,
                'sisa_masa_tenggang' => $today->diffInDays($masaTenggangEnd)
            ];
        } else {
            // Sudah kena denda
            $hariKenaDenda = $today->diffInDays($masaTenggangEnd);
            $totalDenda = $hariKenaDenda * $pengaturan->denda_per_hari;

            return [
                'status' => 'kena_denda',
                'hari' => $hariTerlambat,
                'denda' => $totalDenda,
                'hari_kena_denda' => $hariKenaDenda
            ];
        }
    }

    public function index()
    {
        $pengaturan = PengaturanDenda::getAktif();

        // Data untuk semua tab dengan status lengkap
        $semuaReminders = PeminjamanBuku::with(['buku', 'user'])
            ->where('status', 'dipinjam')
            ->orderBy('tanggal_kembali')
            ->get()
            ->map(function ($reminder) use ($pengaturan) {
                $reminder->status_detail = $this->getStatusPeminjaman($reminder);
                return $reminder;
            });

        // Pisahkan berdasarkan status untuk tabs
        $pengingatPengembalian = $semuaReminders->filter(function ($reminder) {
            return $reminder->status_detail['status'] === 'dalam_waktu';
        });

        $peringatanKeterlambatan = $semuaReminders->filter(function ($reminder) {
            return in_array($reminder->status_detail['status'], ['masa_tenggang', 'kena_denda']);
        });

        // Pisahkan lebih detail untuk tampilan
        $dalamMasaTenggang = $semuaReminders->filter(function ($reminder) {
            return $reminder->status_detail['status'] === 'masa_tenggang';
        });

        $sudahKenaDenda = $semuaReminders->filter(function ($reminder) {
            return $reminder->status_detail['status'] === 'kena_denda';
        });

        return view('admin.reminder.index', compact(
            'pengingatPengembalian',
            'peringatanKeterlambatan',
            'semuaReminders',
            'dalamMasaTenggang',
            'sudahKenaDenda',
            'pengaturan'
        ));
    }

    public function getTerlambat()
    {
        $terlambat = PeminjamanBuku::with(['buku', 'user'])
            ->where('status', 'dipinjam')
            ->where('tanggal_kembali', '<', today())
            ->get();

        return view('admin.reminder.terlambat', compact('terlambat'));
    }

    // METHOD UNTUK MENGIRIM EMAIL OTOMATIS SAAT PEMINJAMAN BARU
    public function kirimEmailPeminjamanBaru($peminjamanId)
    {
        try {
            $peminjaman = PeminjamanBuku::with(['user', 'buku'])->findOrFail($peminjamanId);

            if (!$peminjaman->user || !$peminjaman->user->email) {
                return false;
            }

            // Kirim email konfirmasi peminjaman baru
            Mail::to($peminjaman->user->email)
                ->send(new PeminjamanBaruEmail($peminjaman));

            Log::info('Email peminjaman baru terkirim ke: ' . $peminjaman->user->email);
            return true;
        } catch (\Exception $e) {
            Log::error('Gagal mengirim email peminjaman baru: ' . $e->getMessage());
            return false;
        }
    }

    // METHOD UNTUK MENGIRIM EMAIL BERDASARKAN JENIS
    public function kirimEmailSpesifik($peminjamanId)
    {
        try {
            $peminjaman = PeminjamanBuku::with(['user', 'buku'])->findOrFail($peminjamanId);

            if (!$peminjaman->user || !$peminjaman->user->email) {
                return response()->json([
                    'success' => false,
                    'message' => 'Data peminjam atau email tidak valid'
                ], 400);
            }

            // Gunakan logika status yang baru
            $statusPeminjaman = $this->getStatusPeminjaman($peminjaman);

            switch ($statusPeminjaman['status']) {
                case 'dalam_waktu':
                    // Kirim email pengingat pengembalian
                    Mail::to($peminjaman->user->email)
                        ->send(new PengingatPengembalianEmail($peminjaman, $statusPeminjaman['hari']));
                    $jenisEmail = 'pengingat_pengembalian';
                    $jenisDisplay = 'Pengingat Pengembalian';
                    break;

                case 'masa_tenggang':
                    // Kirim email peringatan masa tenggang
                    Mail::to($peminjaman->user->email)
                        ->send(new PeringatanKeterlambatanEmail($peminjaman, $statusPeminjaman['hari']));
                    $jenisEmail = 'peringatan_keterlambatan';
                    $jenisDisplay = 'Peringatan Masa Tenggang';
                    break;

                case 'kena_denda':
                    // Kirim email peringatan dengan denda
                    Mail::to($peminjaman->user->email)
                        ->send(new PeringatanKeterlambatanEmail($peminjaman, $statusPeminjaman['hari']));
                    $jenisEmail = 'peringatan_keterlambatan';
                    $jenisDisplay = 'Peringatan Kena Denda';
                    break;

                default:
                    throw new \Exception('Status peminjaman tidak valid');
            }

            // Juga kirim notifikasi ke database
            $peminjaman->user->notify(new ReminderDenda($peminjaman, $statusPeminjaman['hari']));

            return response()->json([
                'success' => true,
                'message' => 'Email ' . $jenisDisplay . ' berhasil dikirim ke ' . $peminjaman->user->email . '!',
                'email' => $peminjaman->user->email,
                'jenis_email' => $jenisEmail,
                'jenis_display' => $jenisDisplay,
                'status_peminjaman' => $statusPeminjaman
            ]);
        } catch (\Exception $e) {
            Log::error('Error sending reminder: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengirim email: ' . $e->getMessage()
            ], 500);
        }
    }

    // METHOD UNTUK REMINDER MASSAL DENGAN JENIS YANG TEPAT
    public function kirimReminderMassal(Request $request)
    {
        try {
            $peminjamanIds = $request->input('peminjaman_ids', []);
            $jenisEmail = $request->input('jenis_email', 'semua');

            if (empty($peminjamanIds)) {
                $query = PeminjamanBuku::where('status', 'dipinjam');

                if ($jenisEmail === 'pengingat_pengembalian') {
                    $query->where('tanggal_kembali', '>=', today())
                        ->where('tanggal_kembali', '<=', now()->addDays(3));
                } elseif ($jenisEmail === 'peringatan_keterlambatan') {
                    $query->where('tanggal_kembali', '<', today());
                }

                $peminjamanIds = $query->pluck('id')->toArray();
            }

            $successCount = 0;
            $errorCount = 0;
            $errors = [];
            $jenisEmailCount = [
                'pengingat_pengembalian' => 0,
                'peringatan_keterlambatan' => 0
            ];

            foreach ($peminjamanIds as $peminjamanId) {
                try {
                    $peminjaman = PeminjamanBuku::with(['user', 'buku'])->find($peminjamanId);

                    if ($peminjaman && $peminjaman->user && $peminjaman->user->email) {
                        $tanggalKembali = Carbon::parse($peminjaman->tanggal_kembali);
                        $today = Carbon::today();

                        if (
                            $jenisEmail === 'peringatan_keterlambatan' ||
                            ($jenisEmail === 'semua' && $tanggalKembali->lt($today))
                        ) {
                            // Email keterlambatan
                            $hariTerlambat = $today->diffInDays($tanggalKembali);
                            Mail::to($peminjaman->user->email)
                                ->send(new PeringatanKeterlambatanEmail($peminjaman, $hariTerlambat));
                            $jenisEmailCount['peringatan_keterlambatan']++;
                        } else {
                            // Email pengingat
                            $hariTersisa = $today->diffInDays($tanggalKembali);
                            Mail::to($peminjaman->user->email)
                                ->send(new PengingatPengembalianEmail($peminjaman, $hariTersisa));
                            $jenisEmailCount['pengingat_pengembalian']++;
                        }

                        $successCount++;
                    } else {
                        $errorCount++;
                        $errors[] = "Peminjaman ID {$peminjamanId}: Data peminjam atau email tidak valid";
                    }
                } catch (\Exception $e) {
                    $errorCount++;
                    $errors[] = "Peminjaman ID {$peminjamanId}: " . $e->getMessage();
                }
            }

            return response()->json([
                'success' => true,
                'message' => "Berhasil mengirim {$successCount} email reminder!",
                'data' => [
                    'success' => $successCount,
                    'failed' => $errorCount,
                    'jenis_email' => $jenisEmailCount
                ],
                'errors' => $errors
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengirim reminder massal: ' . $e->getMessage()
            ], 500);
        }
    }

    // ... method lainnya tetap sama


    // METHOD UNTUK REMINDER OTOMATIS HARIAN
    public function otomatisReminder()
    {
        try {
            // Email untuk yang akan datang (1-3 hari lagi)
            $peminjamanAkanDatang = PeminjamanBuku::with('user')
                ->where('status', 'dipinjam')
                ->whereDate('tanggal_kembali', '>=', today())
                ->whereDate('tanggal_kembali', '<=', now()->addDays(3))
                ->get();

            foreach ($peminjamanAkanDatang as $pinjam) {
                $hariTersisa = Carbon::parse($pinjam->tanggal_kembali)->diffInDays(today());
                Mail::to($pinjam->user->email)
                    ->send(new PengingatPengembalianEmail($pinjam, $hariTersisa));
            }

            // Email untuk yang terlambat
            $peminjamanTerlambat = PeminjamanBuku::with('user')
                ->where('status', 'dipinjam')
                ->where('tanggal_kembali', '<', today())
                ->get();

            foreach ($peminjamanTerlambat as $pinjam) {
                $hariTerlambat = Carbon::parse($pinjam->tanggal_kembali)->diffInDays(today());
                Mail::to($pinjam->user->email)
                    ->send(new PeringatanKeterlambatanEmail($pinjam, $hariTerlambat));
            }

            Log::info('Reminder otomatis terkirim: ' .
                $peminjamanAkanDatang->count() . ' pengingat, ' .
                $peminjamanTerlambat->count() . ' keterlambatan');

            return response()->json([
                'success' => true,
                'message' => 'Reminder otomatis terkirim: ' .
                    $peminjamanAkanDatang->count() . ' pengingat, ' .
                    $peminjamanTerlambat->count() . ' keterlambatan'
            ]);
        } catch (\Exception $e) {
            Log::error('Gagal mengirim reminder otomatis: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengirim reminder otomatis: ' . $e->getMessage()
            ], 500);
        }
    }

    public function pustakawanIndex()
    {
        $reminders = PeminjamanBuku::with(['buku', 'user'])
            ->where('status', 'dipinjam')
            ->where('tanggal_kembali', '>=', today())
            ->where('tanggal_kembali', '<=', now()->addDays(3))
            ->orderBy('tanggal_kembali')
            ->get();

        return view('pustakawan.reminder.index', compact('reminders'));
    }
}
